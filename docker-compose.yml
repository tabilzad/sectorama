services:
  app:
    build: .
    image: sectorama:latest
    container_name: sectorama
    restart: unless-stopped
    privileged: true            # required: smartctl + fio need raw block device access
    ports:
      - "8888:8888"
    volumes:
      - app-data:/data          # SQLite DB + other app state
      - /dev:/dev:ro            # host block devices for smartctl discovery + fio benchmarks
    environment:
      - NODE_ENV=production
      - PORT=8888
      - SQLITE_PATH=/data/sectorama.db
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN}
      - INFLUXDB_ORG=sectorama
      - INFLUXDB_BUCKET=sectorama
      - SMART_POLL_INTERVAL_MINUTES=${SMART_POLL_INTERVAL_MINUTES:-60}
      - BENCHMARK_NUM_POINTS=${BENCHMARK_NUM_POINTS:-11}
      - DISK_DISCOVERY_MOCK=false
    depends_on:
      influxdb:
        condition: service_healthy

  influxdb:
    image: influxdb:2
    container_name: sectorama-influxdb
    restart: unless-stopped
    volumes:
      - influxdb-data:/var/lib/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_ADMIN_PASSWORD:-adminpass}
      - DOCKER_INFLUXDB_INIT_ORG=sectorama
      - DOCKER_INFLUXDB_INIT_BUCKET=sectorama
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN}
      # Retention in seconds; 0 = infinite. Default: 180 days (15552000 s).
      # Only applied on first-time setup when the data volume is empty.
      # To change retention on an existing bucket:
      #   docker exec sectorama-influxdb influx bucket update \
      #     --name sectorama --org sectorama --retention 15552000s \
      #     --token <your-token>
      - DOCKER_INFLUXDB_INIT_RETENTION=${INFLUXDB_RETENTION_SECONDS:-15552000}
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  app-data:
  influxdb-data:
